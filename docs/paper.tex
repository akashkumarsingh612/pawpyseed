\documentclass[12pt]{article}
\usepackage{authblk}
\usepackage{enumitem}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{gensymb}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{hyperref}
\usepackage{float}
\usepackage{braket}
\usepackage[margin=1.0in]{geometry}
\usepackage[style=chem-acs,backend=bibtex,articletitle=false]{biblatex}
\graphicspath{ {../../Si_stuff/} }
\bibliography{mybib}

\begin{document}

\newcommand{\ind}{lm\epsilon}

\title{PAWpySeed: A parallelized Python/C package for analyzing
DFT wavefunctions in the PAW formalism}
\author[1]{Kyle Bystrom (kylebystrom@berkeley.edu)}
\affil[1]{UC Berkeley Department of Materials Science and Engineering}
\date{\today}
\maketitle
\abstract{\emph{Note: My current plan is to build this work into a senior thesis,
but currently it is quite messy and incomplete because I still have a lot of work
to do before I will feel comfortable presenting this as a complete work. I would appreciate
any feedback on what I have done so far.}

A parallelized Python and C package has been developed
to perform analysis of density functional theory (DFT) wavefunctions in the
projector augmented wave (PAW) formalism. The primary function of this code
is to calculate the overlap operator of two single-particle Kohn-Sham states
from different periodic structures with the same lattice, which is made nontrivial
by the dependency of PAW augmentation regions on the basis of the structure.
The code is potentially useful for the analysis of point defect levels in
solids because it can determine the composition of defect levels in the basis
of the single-particle states of the bulk system.}

\section{Overview}

In the pure physical picture of a quantum mechanical system, the eigenfunctions of the time
independent Hamiltonian form a complete basis for any function in real space. By expressing
a wavefunction from a system in the basis of the eigenstates of another system, one might
be able to learn about the nature of the wavefunction in question. For example, projecting
the wavefunction of a defect level in a periodic crystal onto the eigenfunctions of the
bulk crystal might yield information about how the defect level is constructed. For example,
the defect state might project primarily onto the conduction band, characterizing it
as a weakly perturbed host state. Such an understanding of defect levels could help select
corrections to perform on the defect system.\cite{lany}

The program developed here is designed to evaluate the overlap operators necessary for the
above projections in the projector augmented wave formalism (PAW) developed by Blochl.\cite{blochl}
pawpyseed interfaces with the Vienna \emph{ab initio} Simulaton
Package (VASP)\cite{vasp,vasp1,vasp2,vasp3,vasp4}, but will interface with other plane wave
codes in the future.

The main purpose of this code is to analyze defect wavefunctions, as explained above;
however, the formalism adn interface developed is relatively general in purpose, and
may suit other uses. The code can perform convenient operations not included in VASP,
such as writing all electron wavefunctions with phases to volumetric data files, which may
be useful for visualization. In addition, one future application plan is to use a given
set of norm-conserving pseudopotentials to convert PAW wavefunctions to NC wavefunctions,
which could be useful for researchers working with GW codes, which usually require
NC wavefunctions. Lastly, operators besides overlap operators can hypothetically be evaluated
in this formalism, which might be useful for optical applications, since materials can
change structure when absorbing a photon.

\section{Theory}

The projector augmented wave (PAW) method defines a transformation between the all electron
(AE) single particle states of the Kohn Sham wavefunction and a pseudo (PS) wavefunction
that is smooth throughout the lattice and therefore can be expressed in a plane wave basis set.\cite{blochl}
This means that the AE wavefunction is a sum of plane waves and site-localized atomic states,
which makes calculating operators difficult if the ion positions change.

\subsection{Projections}

The equation of a PAW wavefunction is\cite{blochl}
\begin{equation}
\ket{\psi_{n\mathbf{k}}}=\ket{\widetilde{\psi}_{n\mathbf{k}}}+
\sum_{a,l,m,\epsilon}(\ket{\phi_{a\ind}}-\ket{\widetilde{\phi}_{a\ind}})
\braket{\widetilde{p}_{a\ind}|\widetilde{\psi}_{n\mathbf{k}}}
\label{eq:1}
\end{equation}
where the sum is over the sites $a$ in the structure and a set of
angular and radial quantum nubers $l$, $m$, and $\epsilon$ at each site.
The conventional overlap operator used for these wavefunctions is
\begin{equation}
\widetilde{A}=A+\sum_i\sum_j\ket{\widetilde{p}_i}(\bra{\phi_i}A\ket{\phi_j}
-\bra{\widetilde{\phi_i}}A\ket{\widetilde{\phi_j}})\bra{\widetilde{p}_j}
\label{eq:loc}
\end{equation}
where $i$ and $j$ are abbreviations for a particular index set
$a,l,m,\epsilon$. This overlap operator requires that the augmentation
regions of the two wavefunctions are same. Since these augmentation regions
are defined by the sites in the structure, the structures must be the same,
so a new formalism is necessary to calculate overlap operators for wavefunctions
in different structures.

\subsubsection{Projection onto Basis from Different Structure}
For two structures (denoted R and S) with the same
lattice but different bases, the overlap operator of two Kohn-Sham single particle states
is described by the following terms:
\begin{equation}
\centering
\begin{split}
\braket{\psi_{Rn_1\mathbf{k}}|\psi_{Sn_2\mathbf{k}}} & =\widetilde{O}+O_M+O_R+O_S+O_N\\
O_M & =\sum_{a\in M_{RS}}\sum_{l,m}\sum_{\epsilon_1}\sum_{\epsilon_2}
\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|\widetilde{p}_{a\ind _1}}
(\braket{\phi_{a\ind _1}|{\phi_{a\ind _2}}}
-\braket{\widetilde{\phi}_{a\ind _1}|\widetilde{\phi}_{a\ind _2}})
\braket{\widetilde{p}_{a\ind _2}|\widetilde{\psi}_{Sn_2\mathbf{k}}}\\
O_R & =\sum_{i\in N_R}\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|\widetilde{p}_i}
(\bra{\phi_i}-\bra{\widetilde{\phi}_i})
\ket{\widetilde{\psi}_{Sn_2\mathbf{k}}}\\
O_S & =\sum_{j\in N_S}\bra{\widetilde{\psi}_{Rn_1\mathbf{k}}}(\ket{\phi_j}-\ket{\widetilde{\phi}_j})
\braket{\widetilde{p}_j|\widetilde{\psi}_{Sn_2\mathbf{k}}}\\
O_N & =\sum_{i,j\in N_{RS}}\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|
\widetilde{p}_i}(\bra{\phi_i}-\bra{\widetilde{\phi}_i})
(\ket{\phi_j}-\ket{\widetilde{\phi}_j})\braket{\widetilde{p}_j|\widetilde{\psi}_{Sn_2\mathbf{k}}}
\end{split}
\label{eq:finp}
\end{equation}
Here, $M_{RS}$ is the set of sites that are identical in structures R and S,
$N_R$ and $N_S$ are all other sites in these structures,
and $N_{RS}$ is teh set of all pairs of sites, one in structure R and one in structure
S, with overlapping augmentation spheres. Equation \ref{eq:finp} is derived in Appendix A.

\section{Implementation}

\begin{table}
\centering
\caption{Runtime scaling functions for each component of the code and
definitions for shorthand symbols to express runtime. Approximate
scales with the number of electrons are also shown.
*The frequency refers to how often the routine is called. "Per band"
indicates that the routine runs once every time a band from one structure
is projected onto all the bands of a basis structure. "Per structure"
indicates that the routine is a "setup" routine that must be called once
for each structure and corresponding band structure to do perform projections. "Per lattice"
operations are required once per unique lattice used.
"Per structure pair" is the same as "per structure" except that the routine
is only run once for a pair of structures with the same lattice and plane-wave
basis set, the bands of one such structure to be used as a basis set for the other.
**Number of sites flexibly refers to the number of sites relevant to the calculation,
which worst-case scales with the total number of sites in the structure. For example,
calculating $O_M$ and $O_N$ only require the sites in sets $M$ and $N_RS$, respectively.}
\label{tab:runtime}

\begin{tabular}{|c|c|c|}
\hline
Computational Task & $\Theta$ & Frequency*\\
\hline
$\widetilde{O}$ & $BKSW \sim n^2$ & per band\\
$O_M$ & $BKSNP \sim n^2$ & per band\\
$O_R$ and $O_S$ & $BKSNP \sim n^2$ & per band\\
$O_N$ & $BKSNP \sim n^2$ & per band\\
$\braket{\widetilde{p}_i|\widetilde{\psi}_{n\mathbf{k}}}$ & $BKSF\mathrm{log}(F)
\sim n^2\mathrm{log}(n)$ & per structure\\
$(\bra{\phi_i}-\bra{\widetilde{\phi}_i})
\ket{\widetilde{\psi}_{n\mathbf{k}}}$ & $BKSNPW \sim n^3$ & per structure\\
spherical Bessel transform partial waves & $NPG\mathrm{log}(G) \sim n$ & per structure pair\\
project plane waves onto partial waves & $EPKW \sim n$ & per lattice\\
projections for overlapping aug spheres & $NPL \sim n$ & per structure pair\\
\hline
\end{tabular}

\begin{tabular}{c|c}
Symbol & Definition\\
\hline
B & number of bands\\
E & number of elements\\
F & size of FFT grid\\
G & size of partial wave radial grid\\
K & number of k-points\\
L & size of Legendre-Gauss grid around ions\\
N & number of sites**\\
P & number of projector functions\\
S & number of spin states\\
W & number of plane waves\\
n & number of electrons (approximate scaling)
\end{tabular}
\end{table}

The program is implemented as a Python package that interfaces with C functions through
the Python ctypes package. Time consuming routines are performed in C and parallelized
using openmp, meaning that the code will automatically parallelize on all the resources
of a shared memory computing node. Detailed runtime scaling for each routine is
provided in Table \ref{tab:runtime}. An explanation of how each term is calculated
so as to maximize computational efficiency is summarized in the following subsections.

\subsection{Projector function evaluation}

The projector function overlaps with the plane-wave states are calculated using the same
algorithm as VASP.\cite{vasp}

\subsection{Projection of Pseudowavefunctions onto Partial Waves}

The all electron partial waves fluctuate rapidly near the nucleus,
so the pseudowavefunction cannot be projected onto the partial waves
via coarse Cartesian grid as is doen with the projector functions.
However, A plane wave can be expanded as a sum of spherical
Bessel functions via Rayleigh expansion.
\begin{equation}
e^{i\mathbf{k} \cdot \mathbf{r}} = 4\pi \sum_{l=0}^{\infty}\sum_{m=-l}^{l}
i^l j_l(kr)Y_l^{m*}(\mathbf{\hat{k}})Y_l^m(\mathbf{\hat{r}})
\label{eq:pwexp}
\end{equation}
Therefore, the overlap operator between a partial wave and plane wave can be evaluated as a summation
of spherical Bessel function overlap integrals. The following definitions are
used in this derivation:

$\mathbf{r_A} = \mathbf{r} - \mathbf{R_A}$, $\phi_i(\mathbf{r})=R_i(r)Y_l^m(\mathbf{\hat{r}})$,
$\widetilde{\phi}_i(\mathbf{r})=\widetilde{R}_i(r)Y_l^m(\mathbf{\hat{r}})$,
$\mathbf{k'}=\mathbf{k}+\mathbf{G}$\\
The derivation goes as follows, with the last line being that needed to 
calculate $O_R$ and $O_S$:

\begin{equation}
\begin{split}
\widetilde{\psi}_{n\mathbf{k}} & =\frac{1}{\sqrt{V}}\sum_{\mathbf{G}}
C_{n\mathbf{k}\mathbf{G}}e^{i\mathbf{k'}\cdot \mathbf{r}}\\
\widetilde{\psi}_{n\mathbf{k}} & =\frac{4\pi}{\sqrt{V}}\sum_{\mathbf{G}}
C_{n\mathbf{k}\mathbf{G}}\sum_{l=0}^{\infty}\sum_{m=-l}^{l}
i^l j_l(k'r_A)Y_l^{m*}(\mathbf{\hat{k'}})Y_l^m(\mathbf{\hat{r}_A})\\
\phi_i(\mathbf{r})\widetilde{\psi}_{n\mathbf{k}} & =\frac{4\pi}{\sqrt{V}}\sum_{\mathbf{G}}
C_{n\mathbf{k}\mathbf{G}}\sum_{l'=0}^{\infty}\sum_{m'=-l'}^{l'}
i^{l'} j_{l'}(k'r_A)Y_{l'}^{m'*}(\mathbf{\hat{k'}})Y_{l'}^{m'}(\mathbf{\hat{r}_A})
Y_l^{m*}(\mathbf{\hat{r}}_A)R_i(r_A)\\
\braket{\phi_i(\mathbf{r})|\widetilde{\psi}_{n\mathbf{k}}} & =
\frac{4\pi i^l}{\sqrt{V}}\sum_{\mathbf{G}} C_{n\mathbf{k}\mathbf{G}}
Y_l^{m*}(\mathbf{\hat{k'}})\int_0^{\infty}drr^2R_i(r_A)j_l(k'r_A)\\
\braket{\phi_i-\widetilde{\phi}_i|\widetilde{\psi}_{n\mathbf{k}}} & =
\frac{4\pi i^l}{\sqrt{V}}\sum_{\mathbf{G}} C_{n\mathbf{k}\mathbf{G}}
Y_l^{m*}(\mathbf{\hat{k'}})\int_0^{\infty}drr^2(R_i(r_A)-\widetilde{R}_i(r_A))j_l(k'r_A)
\end{split}
\end{equation}

After the projection is decomposed into a summation over integrals of spherical
Bessel functions, it can be calculated via spherical Bessel transform. This code
uses the fast spherical Bessel transform method NumSBT developed by Talman.\cite{TALMAN}
It runs in $O(NlnN)$ time and works on a logarithmic grid, making it convenient for use with
the POTCAR representations of the partial waves. The resulting logarithmic k-space
grid can be used to calculate the values of the relevant integrals via interpolation.

The current implementation uses the "high-k" algorithm developed by Talman. At low
values of k, this algorithm becomes imprecise, though the precision
of the current implementation has been tested and found to be about
$10^{-3}$ for a bulk Ga test system. Future versions of the code
will select the most precise of the "low-k" and "high-k" algorithms for each point,
and the density of the momentum space grid will be increased.

The main problem with this algorithm is that it is the slowest component of the code
and consumes the majority of the computational time even when only a few sites out
of a structure with hundreds of sites require the calculation. A potential fix is,
rather than integrating in reciprocal space, which becomes prohibitively slow for large
lattices, to remove the high-frequency components of the partial waves via Fourier transform.
This is counterintuitive because the purpose of the partial waves is to preserve the high-frequency
components of the atomic wavefunctions, but when projecting onto the smooth pseudowavefunction,
the high-frequency components have no impact because they are not present in the pseudowavefunction.
Removing the high frequency components, therefore, allows the projection onto the partial waves
to be done in real space without aliasing.

\subsection{Projections for Overlapping Augmentation Spheres}

For two different structures, it is possible for atoms to have augmentation spheres
that overlap but are not directly on top of each other, or to have atoms of different elements
with the same position. In these cases, the overlap integrals of the partial waves
must be evaluated numerically on a per structure pair basis. The current method is a relatively
crude discrete integral in 3D space, which is the limiting factor in the precision of the code.
The current precision of this two-center overlap integral is about $10^{-2}$, which is adequate
for qualitative evaluations of band composition but not for quantitative charge corrections.

An implementation is in development in which a kernel function developed by Hierse and
Oppeneer is used to reduce the 3-dimensional discrete integrals
to the integral of an analytical term over the two radial distribution functions.\cite{hierse_kernel} 
This method has the potential to vastly improve both the performance and precision of
this step of the code, but the relevant kernel function for overlap integrals
scales inversely with the internuclear separation, so detailed tests are required
to design the implementation in a numerically precise fashion. Most likely, it will be
best to divide the integrals into three cases: (1) internuclear separation is very small
and can be assumed to vanish, (2) internuclear separation is small, but not small enough
to be ignored numerically, but the kernel function at a given $r_1$ is very narrow
in $r_2$, (3) the internuclear separation is large and the kernel function smooth everywhere
relative to the partial wave grid density.

The Gaunt coefficients are required for the evaluation of the kernel function, and these
are calculated and stored efficiently with sympy and the selection rules for \cite{gaunt_selection}.

\section{Results and Example Usage}

To test the program for its primary purpose of defect level analysis, the projection
of a defect level wavefunction onto the valence band of the bulk is defined:
\begin{equation}
v_d=\sum_{\mathbf{k}}\sum_{i\in \mathbb{V}}|\braket{\psi_{Bn_i\mathbf{k}}|\psi_{Dn_d\mathbf{k}}}|^2
\label{eq:vproj}
\end{equation}
where $i$ are the band indices of valence bands $\mathbb{V}$ in the bulk structure, the $B$
subscript denotes the bulk band structure, and the $D$ subscript denotes the point defect
band structure. This value, as well as the similarly defined $c_d$ for the conduction band,
were calculated for several charge states of the silicon single vacancy, phosphorus substitutional,
and boron substitutional. A 128-atom supercell was used (127 for the vacancy), with
the PBE GGA functional in VASP.\cite{gga,ggaerr} A Monkhorst-Pack 2x2x2 k-point mesh was used.

\begin{figure}
\includegraphics[width=0.32\textwidth]{Bcharge_0.png}
\includegraphics[width=0.32\textwidth]{Bcharge_-1.png}
\includegraphics[width=0.32\textwidth]{Pcharge_0.png}
\includegraphics[width=0.32\textwidth]{Pcharge_1.png}
\includegraphics[width=0.32\textwidth]{charge_-2.png}
\includegraphics[width=0.32\textwidth]{charge_-1.png}
\includegraphics[width=0.32\textwidth]{charge_0.png}
\includegraphics[width=0.32\textwidth]{charge_1.png}
\includegraphics[width=0.32\textwidth]{charge_2.png}
\caption{Valence and conduction band character of several charge states
of three Si point defects, determined by evaluating the overlap
operator between all electron wavefunctions. The charge states prefixed by B are
boron substitutionals, those prefixed by P are phosphorous substitutionals,
and those without a prefix are Si single vacancies.}
\label{fig:ae_proj}
\end{figure}

\begin{figure}
\includegraphics[width=0.32\textwidth]{pseudo/Bcharge_0.png}
\includegraphics[width=0.32\textwidth]{pseudo/Bcharge_-1.png}
\includegraphics[width=0.32\textwidth]{pseudo/Pcharge_0.png}
\includegraphics[width=0.32\textwidth]{pseudo/Pcharge_1.png}
\includegraphics[width=0.32\textwidth]{pseudo/charge_-2.png}
\includegraphics[width=0.32\textwidth]{pseudo/charge_-1.png}
\includegraphics[width=0.32\textwidth]{pseudo/charge_0.png}
\includegraphics[width=0.32\textwidth]{pseudo/charge_1.png}
\includegraphics[width=0.32\textwidth]{pseudo/charge_2.png}
\caption{Valence and conduction band character of several charge states
of three Si point defects, determined by only evaluating
the overlap operator between pseudowavefunctions and then forcibly
normalizing the result to 1. The charge states prefixed by B are
boron substitutionals, those prefixed by P ar phosphorous substitutionals,
and those without a prefix are Si single vacancies.}
\label{fig:ps_proj}
\end{figure}

Figure \ref{fig:ae_proj} shows the valence and conduction band characters of
each defect and charge state. The shallow character of the phosphorous and boron
substitutionals result in each band being strongly associated with either the bulk
or conduction bands. In the Si vacancy, three bands have some mixing of conduction
and valence character, which is sensible because the vacancy is a deeper defect.

The same defects are analyzed in Figure \ref{fig:ps_proj}, except that the overlap
operators were evaluated using pseudowavefunctions, which is much faster but
less physically meaningful because the pseudowavefunctions are unnormalized
and not orthogonal (the
diagram forcibly normalizes valence and conduction character) and
different in shape than the true AE single-particle states. However, as shown
for these simple Si systems, the same qualitative valence-conduction character is
observed, indicating that such qualitative methods might be useful for more quickly
analyzing bands.

The sulfur substitutional in silicon was analyzed in a 216-atom supercell,
but further work is required to interpret the results meaningfully, so they
will be released in future work.

\section{Conclusions and Future Work}

Most of the work performed thus far has centered on the writing and testing of
PAWpySeed for basic functionality on various systems. As elaborated below,
a major goal for future work is to add new functionality to PAWpySeed and increase
its precision. However, the most prescient matter is taking the results
accumulated on test defect systems and comparing the output of PAWpySeed to the
DFT formation energies and eigenvalues of the systems. The results above
verify the functionality of the code but not its usefulness, which will only
be discernible in comparision with the quantitative output of the DFT calculations.
This, along with increasing the efficiency and precision of the code, will be
the main goal of work over the next several months.

PAWpySeed provides useful utilities for reading and analyzing PAW wavefunctions
from VASP, particularly for point defect levels. However, the current capabilities
of PAWpySeed are primarily qualitative because of mediocre numerical precision
and a lack of quantitative applications of the code. One potential quantitative
application to be developed in the future is the perturbation theory correction
proposed by Lany and Zunger for correcting defect level energies.\cite{lany}
The main barriers to such a correction are currently the lack of adequate
description of the deep level character of the defects and the difference
between the single particle states of DFT and higher level-of-theory
single-particle states. Work to resolve such issues is currently in development.
Namely, code is being written to construct atomic vacuum states onto which
PAW wavefunctions can be projected. In addition, the SCDM-k decomposition method
will be written into PAWpySeed to construct localized orbitals for energy
corrections.\cite{scdm,scdmk}

\section{Acknowledgments}

I would like to thank Danny Broberg and Mark Asta for excellent advising
and encouragement throughout my work with the Asta Research Group at UC Berkeley,
as well as all the members of the Asta Research Group and Hacking Materials
Research Group at Lawrence Berkeley National Laboratory for various
valuable research and learning opportunities. My summer 2017 undergraduate
research, mainly related to development of an open-source data science code
called matminer, was supported
by a summer research stipend from the UC Berkeley College of Chemistry.

\section*{Appendix A: Derivation of Overlap Operators from PAW Formalism}

The following section derives an equation for the overlap operator between one
Kohn-Sham single particle state of one structure R and one Kohn-Sham single
particle state of another structure S, where R and S share a common lattice
and the DFT wavefunctions are constructed with the same plane-wave PAW basis set.
It should be noted this derivation might better be described as a manipulation
of terms of the PAW pseudo-operator, because its main purpose is to present
the overlap operator in a method convenient for computation rather than to derive
an entirely new expression. The derivation also makes particular note of how
the expression of the overlap operator relates to interfacing with the VASP code,
though the expressions are applicable to any PAW code.

The starting point for this derivation is the transformation operator that
is performed on the pseudowavefunction to obtain the all electron wavefunction
\begin{equation}
T=1+\sum_a\sum_l\sum_m\sum_{\epsilon}(\ket{\phi_{a\ind}}-\ket{\widetilde{\phi}_{a\ind}})
\bra{\widetilde{p}_{a\ind}}=1+\sum_i(\ket{\phi_i}-\ket{\widetilde{\phi}_i})
\bra{\widetilde{p}_i}
\label{eq:T}
\end{equation}
where $\phi_{a\ind}$ are all electron (AE) partial waves, $\widetilde{\phi}_{a\ind}$
are pseudo (PS) partial waves, $\widetilde{p}_{a\ind}$ are projector functions,
$a$ are the site indices of each atom in the structure, and $l$, $m$, and $\epsilon$
specify a spherical harmonic and index which uniquely specify partial wave at a given
index. A summation over $i$ (or $j$, as below) represents a summation over $a$, $l$, $m$,
and $\epsilon$. For further details on the PAW method, including the physical significance
and construction of the partial waves and projector functions, see Blochl's original paper
and Kresse and Joubert's paper relating ultrasoft pseudopotentials and PAW.\cite{blochl,vasp4}
The next step is to define a pseudo operator $\widetilde{A}$ for each operator $A$
such that $\bra{\psi}A\ket{\psi}=\bra{\widetilde{\psi}}\widetilde{A}\ket{\widetilde{\psi}}$.
Because $\ket{\psi}=T\ket{\widetilde{\psi}}$, one can write
\begin{equation}
\widetilde{A}=T^{\dagger}AT
\label{eq:op}
\end{equation}
One can then plug Equation \ref{eq:T} into Equation \ref{eq:op} to find
\begin{equation}
\begin{split}
\widetilde{A} = & [1+\sum_i\ket{\widetilde{p}_i}(\bra{\phi_i}-\bra{\widetilde{\phi}_i})]
A[1+\sum_j(\ket{\phi_j}-\ket{\widetilde{\phi}_j})
\bra{\widetilde{p}_j}]\\
\widetilde{A} = & A+\sum_i\ket{\widetilde{p}_i}(\bra{\phi_i}-\bra{\widetilde{\phi}_i})A
+\sum_j A(\ket{\phi_j}-\ket{\widetilde{\phi}_j})\bra{\widetilde{p}_j}\\
& +\sum_i\sum_j\ket{\widetilde{p}_i}(\bra{\phi_i}-\bra{\widetilde{\phi}_i})A
(\ket{\phi_j}-\ket{\widetilde{\phi}_j})\bra{\widetilde{p}_j}
\end{split}
\label{eq:res}
\end{equation}

Using the following relation,
\begin{equation}
\begin{split}
(\bra{\phi_i}-\bra{\widetilde{\phi}_i})A(\ket{\phi_j}-\ket{\widetilde{\phi}_j})
& =\bra{\phi_i}A\ket{\phi_j}-\bra{\widetilde{\phi}_i}A\ket{\phi_j}
-(\bra{\phi_i}-\bra{\widetilde{\phi}_i})A\ket{\widetilde{\phi}_j}\\
& =\bra{\phi_i}A\ket{\phi_j}-\bra{\widetilde{\phi}_i}A(\ket{\phi_j}-\ket{\widetilde{\phi_j}})
-(\bra{\phi_i}-\bra{\widetilde{\phi}_i})A\ket{\widetilde{\phi}_j}
-\bra{\widetilde{\phi_i}}A\ket{\widetilde{\phi_j}}
\end{split}
\end{equation}

one can rearrange Equation \ref{eq:res} in the manner of Blochl\cite{blochl}:
\begin{equation}
\begin{split}
\widetilde{A}= & A+\sum_i\sum_j[\ket{\widetilde{p}_i}(\bra{\phi_i}A\ket{\phi_j}
-\bra{\widetilde{\phi_i}}A\ket{\widetilde{\phi_j}})\bra{\widetilde{p}_j}] \\
& +\sum_i[(1-\sum_j\ket{\widetilde{p}_j}\bra{\widetilde{\phi}_j})A(\ket{\phi_i}-\ket{\widetilde{\phi_i}})
\bra{\widetilde{p}_i}+\ket{\widetilde{p}_i}
(\bra{\phi_i}-\bra{\widetilde{\phi}_i})A(1-\sum_j\ket{\widetilde{\phi}_j}\bra{\widetilde{p}_j})]
\end{split}
\label{eq:nonloc}
\end{equation}
When the operator $A$ is local, then $\sum_j\ket{\widetilde{\phi}_j}\bra{\widetilde{p}_j}=1$,
so the entire second line of Equation \ref{eq:nonloc} vanishes, giving Blochl's formulation:\cite{blochl}
\begin{equation}
\widetilde{A}=A+\sum_i\sum_j\ket{\widetilde{p}_i}(\bra{\phi_i}A\ket{\phi_j}
-\bra{\widetilde{\phi_i}}A\ket{\widetilde{\phi_j}})\bra{\widetilde{p}_j}
\label{eq:loc1}
\end{equation}

However, while the overlap operator is local, the simplification in Equation \ref{eq:loc1} assumes that
the summations over $i$ and $j$ go over the same species at the same locations in the same lattice;
only the third condition is always satisfied for systems of interest for projections between different
bases. Equation \ref{eq:res} is a more convenient representation than Equation \ref{eq:nonloc} for this
purpose because it is easily seen that all terms between projectors whose augmentation regions do not
overlap vanish. In addition, the POTCAR file in VASP only stores the PS and AE partial waves out to the
edge of the augmentation region, where they are equal but not nonzero, so it is useful to organize the terms
so that they are guaranteed to vanish outside the augmentation regions. Replacing $A$ with unity
allows the overlap between two bands
in different structures $R$ and $S$ with the same lattice to be specified (note that the
summation over $i$ is for structure $R$ and the summation over $j$ is for structure $S$):
\begin{equation}
\begin{split}
\braket{\psi_{Rn_1\mathbf{k}}|\psi_{Sn_2\mathbf{k}}} & =\widetilde{O}+O_1+O_2+O_3\\
\widetilde{O} & =\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|\widetilde{\psi}_{Sn_2\mathbf{k}}}\\
O_1 & =\sum_i\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|\widetilde{p}_i}(\bra{\phi_i}-\bra{\widetilde{\phi}_i})
\ket{\widetilde{\psi}_{Sn_2\mathbf{k}}}\\
O_2 & =\sum_j\bra{\widetilde{\psi}_{Rn_1\mathbf{k}}}(\ket{\phi_j}-\ket{\widetilde{\phi}_j})
\braket{\widetilde{p}_j|\widetilde{\psi}_{Sn_2\mathbf{k}}}\\
O_3 & =\sum_i\sum_j\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|
\widetilde{p}_i}(\bra{\phi_i}-\bra{\widetilde{\phi}_i})
(\ket{\phi_j}-\ket{\widetilde{\phi}_j})\braket{\widetilde{p}_j|\widetilde{\psi}_{Sn_2\mathbf{k}}}
\end{split}
\label{eq:ov1a}
\end{equation}

The pseudowavefunctions can be expanded as a summation of plane waves,
$$\widetilde{\psi}_{n\mathbf{k}}(\mathbf{r})=\sqrt{\frac{\omega_{\mathbf{k}}}{V}}
e^{i\mathbf{k}\cdot \mathbf{r}}\sum_{\mathbf{G}} C_{n\mathbf{k}\mathbf{G}}
e^{i\mathbf{G}\cdot \mathbf{r}}$$
so the overlap between two pseudowavefunctions per unit cell can be written as
$$\widetilde{O}=\braket{\widetilde{\psi}_{n_1\mathbf{k}_1}|\widetilde{\psi}_{n_2\mathbf{k}_2}}
=\delta_{\mathbf{k}_1,\mathbf{k}_2}
\omega_{\mathbf{k}} \sum_{\mathbf{G}} C^*_{n_1\mathbf{k}_1\mathbf{G}}C_{n_2\mathbf{k}_2\mathbf{G}}$$

In VASP, structures with the same energy, k-points, and lattice will have the same basis set,
so this projection is performed simply by reading plane wave coefficients from the VASP WAVECAR file.

It is important to simplify the calculation of the other terms in equation \ref{eq:ov1a} as much
as possible because their calculation can be quite computationally intensive, and the number of
necessary calculations for projecting onto an entire basis set can scale with the number
of sites times the size of the basis set. One major simplification is that if a site $a$ in structure
$R$ and site $b$ in structure $S$ have the same species and position, $a$ and $b$ will only have
overlapping augmentation regions with each other and no other sites. Then, defining $O_{1a}$
as the summation over on-site terms for the identical sites $a$ and $b$ in $O_1$:
$$O_{1a}+O_{2a}+O_{3a}=\sum_{l,m}\sum_{\epsilon_1}\sum_{\epsilon_2}
\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|\widetilde{p}_{a\ind _1}}
(\braket{\phi_{a\ind _1}|{\phi_{a\ind _2}}}
-\braket{\widetilde{\phi}_{a\ind _1}|\widetilde{\phi}_{a\ind _2}})
\braket{\widetilde{p}_{a\ind _2}|\widetilde{\psi}_{Sn_2\mathbf{k}}}$$
which is the local operator solution derived by Blochl. All three terms must
be evaluated in full for the other sites, but terms in $O_3$ where $i$ and $j$ correspond
to sites with nonoverlapping augmentation spheres vanish. Therefore, if $M_{RS}$ is the set
of identical sites in the structures $R$ and $S$, $N_R$ and $N_S$ are the sets of sites
in $R$ and $S$ not in $M_{RS}$, and $N_{RS}$ is the set of \emph{pairs} of sites not in
$M$ with overlapping augmentation regions, then
$$
\braket{\psi_{Rn_1\mathbf{k}}|\psi_{Sn_2\mathbf{k}}}=\widetilde{O}+O_M+O_R+O_S+O_N
$$
$$
O_M=\sum_{a\in M_{RS}}\sum_{l,m}\sum_{\epsilon_1}\sum_{\epsilon_2}
\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|\widetilde{p}_{a\ind _1}}
(\braket{\phi_{a\ind _1}|{\phi_{a\ind _2}}}
-\braket{\widetilde{\phi}_{a\ind _1}|\widetilde{\phi}_{a\ind _2}})
\braket{\widetilde{p}_{a\ind _2}|\widetilde{\psi}_{Sn_2\mathbf{k}}}
$$
$$
O_R=\sum_{i\in N_R}\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|\widetilde{p}_i}
(\bra{\phi_i}-\bra{\widetilde{\phi}_i})
\ket{\widetilde{\psi}_{Sn_2\mathbf{k}}}
$$
$$
O_S=\sum_{j\in N_S}\bra{\widetilde{\psi}_{Rn_1\mathbf{k}}}(\ket{\phi_j}-\ket{\widetilde{\phi}_j})
\braket{\widetilde{p}_j|\widetilde{\psi}_{Sn_2\mathbf{k}}}
$$
$$
O_N=\sum_{i,j\in N_{RS}}\braket{\widetilde{\psi}_{Rn_1\mathbf{k}}|
\widetilde{p}_i}(\bra{\phi_i}-\bra{\widetilde{\phi}_i})
(\ket{\phi_j}-\ket{\widetilde{\phi}_j})\braket{\widetilde{p}_j|\widetilde{\psi}_{Sn_2\mathbf{k}}}
$$
which is Equation \ref{eq:finp}.

\section*{Appendix B: Comprehensive POTCAR Guide}
The PAWpySeed module makes use of the POTCAR files provided with the VASP source code, which
contain the projector functions, partial waves, pseudopotentials, and core charge densities
for each element. The format of the POTCAR file is not intuitive to non-developers, so this
appendix seeks to comprehensively document the format of the VASP POTCAR files.

\subsection*{Overview}
A single POTCAR contains the data for one element; a POTCAR file to a multi-element system
is made by simply concatenating elemental POTCAR files. Each PAW POTCAR file follows
the following format.

\begin{enumerate}
	\item
	\textbf{Settings}: The parameters used for the generation of the psuedopotentials,
	as described thoroughly in VASP and pymatgen documentation.
	\item
	A bunch of stuff I still don't understand and which has no discernible grid.
	\item
	\textbf{Non local Part}: This section contains the \emph{non local projector functions}.
	The first line after "Non local Part" gives the $l$ quantum number of the projector,
	the number of projectors for that $l$ quantum number, and the radius of the real
	space projector region.
	\begin{enumerate}
		\item
		\textbf{Reciprocal Space Part}: The reciprocal space projection operator.
		\item
		\textbf{Real Space Part}: The real space projection operator values on a radial
		grid. The radius at a given index $I$ is $RMAX*I/NDATA$, where RMAX and NDATA
		are given in the settings section. Since $I$ is 0-indexed, the true maximal
		radius of the projector is actually $RMAX*(NDATA-1)/NDATA$. Unlike the
		\emph{partial wave} values (see \textbf{pseudo wavefunction},
		the projector values are not mulitplied by $r$.
		$$p(\mathbf{r})=realspacepart(index)Y_l^m(\hat{\mathbf{r}})$$
	\end{enumerate}
	\item
	\textbf{PAW Radial Sets}
	\begin{enumerate}
		\item
		Augmentation charges
		\item
		Occupancies
		\item
		\textbf{grid}: The exponential grid on which calculations related
		to the \emph{partial waves} are performed.
		\item
		\textbf{pseudo wavefunction}: A pseudo \emph{partial wave} on the provided
		radial grid, multiplied by $r$ for easy radial integration. I.e.
		$$\phi(\mathbf{r}(index))=\frac{pseudowavefunction(index)}{r(index)}Y_l^m(\hat{\mathbf{r}})$$
		Listed in the same order as the projector functions.
		\item
		\textbf{ae wavefunction}: Same pseudo wavefunction, but for the all electron \emph{partial wave}.
	\end{enumerate}
\end{enumerate}

\subsection*{}

\printbibliography

\end{document}